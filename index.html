<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ลงทะเบียนฝึกอบรม</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; background: #f7f7f7; }
    .box { background: #fff; max-width: 400px; margin: auto; padding: 2em; border-radius: 12px; box-shadow: 0 2px 8px #0001; }
    label { display: block; margin-top: 1em; }
    button { margin-top: 2em; width: 100%; padding: 1em; }
    #result { margin-top: 1.5em; color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <div class="box">
    <h2>ลงทะเบียนฝึกอบรม</h2>
    <form id="registerForm" style="display:none;">
      <input type="hidden" id="userId" name="userId">
      <label>รหัสอบรม:
        <input type="text" id="code" name="code" required>
      </label>
      <label>รหัสพนักงาน:
        <input type="text" id="empId" name="empId" required>
      </label>
      <button type="submit">ลงทะเบียน</button>
    </form>
    <div id="result"></div>
    <div id="loading">กำลังโหลด...</div>
  </div>
  <script>
    // ใส่ LIFF ID ของคุณเองจาก LINE Developers
    const liffId = "2004735926-kK8G6N9G";
    // ใส่ URL Google Apps Script Web App ที่ Deploy ไว้แล้ว (https://script.google.com/macros/s/....../exec)
    const backendURL = "https://script.google.com/macros/s/AKfycbzyvzWNPLZMzaaRbCRHg6oPuBoNT3iEs8ZGQzklBCe_68XOEJUkNXAGiokrcpyaf2ikHw/exec";

    function showForm() {
      document.getElementById('registerForm').style.display = 'block';
      document.getElementById('loading').style.display = 'none';
    }

    function showLoading(msg) {
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('loading').innerText = msg;
      document.getElementById('loading').style.display = 'block';
    }

    liff.init({ liffId })
      .then(() => liff.getProfile())
      .then(profile => {
        document.getElementById('userId').value = profile.userId;
        showForm();
      })
      .catch(err => {
        document.getElementById('result').innerHTML = '<span class="error">LIFF error: ' + err + '</span>';
        document.getElementById('loading').style.display = 'none';
      });

    document.getElementById('registerForm').addEventListener('submit', function(e){
      e.preventDefault();
      showLoading("กำลังบันทึก...");
      const data = {
        userId: document.getElementById('userId').value,
        code: document.getElementById('code').value,
        empId: document.getElementById('empId').value
      };

      fetch(backendURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(result => {
        if(result.status === "ok") {
          document.getElementById('result').innerText = "ลงทะเบียนสำเร็จ: " + result.course + "\n" + result.fullName;
        } else {
          document.getElementById('result').innerHTML = '<span class="error">' + (result.message || 'เกิดข้อผิดพลาด') + '</span>';
        }
        showForm();
        document.getElementById('registerForm').reset();
      })
      .catch(err => {
        document.getElementById('result').innerHTML = '<span class="error">เกิดข้อผิดพลาด: ' + err + '</span>';
        showForm();
      });
    });
  </script>
</body>
</html>